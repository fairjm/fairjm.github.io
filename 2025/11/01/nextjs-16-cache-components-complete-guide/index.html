<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Next.js 16 Cache Components 完全指南 | 小麦的杂货铺</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="基于 Next.js 16.0.1 官方文档整理  目录 什么是 Cache Components 核心工作原理 使用 Suspense 边界 使用 use cache 启用 Cache Components 从旧版本迁移 实战示例 最佳实践 和 Next-intl 结合 常见错误与解决方案 FAQ 参考资料   这边文档主要是 AI 总结+我补充实际遇到的问题，大部分是 AI 写的。 注意，文">
<meta property="og:type" content="article">
<meta property="og:title" content="Next.js 16 Cache Components 完全指南">
<meta property="og:url" content="https://bingowith.me/2025/11/01/nextjs-16-cache-components-complete-guide/index.html">
<meta property="og:site_name" content="小麦的杂货铺">
<meta property="og:description" content="基于 Next.js 16.0.1 官方文档整理  目录 什么是 Cache Components 核心工作原理 使用 Suspense 边界 使用 use cache 启用 Cache Components 从旧版本迁移 实战示例 最佳实践 和 Next-intl 结合 常见错误与解决方案 FAQ 参考资料   这边文档主要是 AI 总结+我补充实际遇到的问题，大部分是 AI 写的。 注意，文">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://h8dxkfmaphn8o0p3.public.blob.vercel-storage.com/learn/light/thinking-in-ppr.png">
<meta property="og:image" content="https://h8dxkfmaphn8o0p3.public.blob.vercel-storage.com/docs/light/server-rendering-with-streaming.png">
<meta property="og:image" content="https://h8dxkfmaphn8o0p3.public.blob.vercel-storage.com/docs/light/sequential-parallel-data-fetching.png">
<meta property="article:published_time" content="2025-11-01T08:58:02.000Z">
<meta property="article:modified_time" content="2025-11-01T08:58:02.000Z">
<meta property="article:author" content="abaabaqua">
<meta property="article:tag" content="Next.js">
<meta property="article:tag" content="Cache Components">
<meta property="article:tag" content="React">
<meta property="article:tag" content="Next.js 16">
<meta property="article:tag" content="Web Development">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://h8dxkfmaphn8o0p3.public.blob.vercel-storage.com/learn/light/thinking-in-ppr.png">
  
    <link rel="alternate" href="/atom.xml" title="小麦的杂货铺" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css">

  
<!-- hexo injector head_end start -->
    <link rel="stylesheet" href="/css/cc_custom.css">
  <!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">小麦的杂货铺</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">日常随笔~</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/fairjm"><span class="fa fa-github"></span></a>
          
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://bingowith.me"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-nextjs-16-cache-components-complete-guide" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/01/nextjs-16-cache-components-complete-guide/" class="article-date">
  <time class="dt-published" datetime="2025-11-01T08:58:02.000Z" itemprop="datePublished">2025-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Next.js 16 Cache Components 完全指南
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>基于 Next.js 16.0.1 官方文档整理</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-cache-components">什么是 Cache Components</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">核心工作原理</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-suspense-%E8%BE%B9%E7%95%8C">使用 Suspense 边界</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-use-cache">使用 use cache</a></li>
<li><a href="#%E5%90%AF%E7%94%A8-cache-components">启用 Cache Components</a></li>
<li><a href="#%E4%BB%8E%E6%97%A7%E7%89%88%E6%9C%AC%E8%BF%81%E7%A7%BB">从旧版本迁移</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B">实战示例</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
<li><a href="#%E5%92%8C-Next-intl-%E7%BB%93%E5%90%88">和 Next-intl 结合</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">常见错误与解决方案</a></li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ol>
<hr>
<p>这边文档主要是 AI 总结+我补充实际遇到的问题，大部分是 AI 写的。</p>
<p>注意，文档里不包含<code>use cache: private</code>的内容，在写的时候本来官方文档里说依赖<code>unstable_prefetch</code>，但是后来一看这个内容又被移除了，不知道后续会不会再改，先不写了，以官方文档为准。<a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/directives/use-cache-private">API Reference &gt; Directives &gt; use cache: private</a></p>
<p>注意，现在的 16.0 还在不断变化中，还是等 16.1，16.2 再用吧。这东西太不稳了。</p>
<p><code>Cache components</code>除了方便的 PPR+显式缓存，另外一个就是在框架层面（主要是 dev 和构建的时候），防止用户写出动态内容卡住整个页面加载的事，这在之前很容易写出来，网上也有很多批评的文章和视频，一看连<code>loading.tsx</code>和<code>Suspense</code>都不会用。😂<br>现在官方强制了，也是件好事吧。</p>
<h2 id="什么是-Cache-Components"><a href="#什么是-Cache-Components" class="headerlink" title="什么是 Cache Components"></a>什么是 Cache Components</h2><p><strong>Cache Components</strong> 是 Next.js 16 中一种新的渲染和缓存方法，通过 <strong>Partial Prerendering (PPR)</strong> 提供细粒度的缓存控制，同时确保出色的用户体验。</p>
<h3 id="核心关系"><a href="#核心关系" class="headerlink" title="核心关系"></a>核心关系</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache Components = PPR + use cache</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>PPR</strong> 提供静态外壳和流式传输基础设施</li>
<li><strong><code>use cache</code></strong> 让你在外壳中包含优化的动态输出</li>
</ul>
<h3 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h3><p>在开发动态应用时，你需要在两种方式之间权衡：</p>
<ul>
<li>❌ <strong>完全静态页面</strong>：加载快，但无法显示个性化或实时数据</li>
<li>❌ <strong>完全动态页面</strong>：可显示最新数据，但每次请求都需要渲染所有内容，导致初始加载慢</li>
</ul>
<span id="more"></span>

<p>✅ <strong>Cache Components 的解决方案</strong>：</p>
<p>启用 Cache Components 后，Next.js 将所有路由<strong>默认视为动态</strong>。每个请求都使用最新可用数据渲染。但大多数页面由静态和动态部分组成，并非所有动态数据都需要在每次请求时从源获取。</p>
<p>Cache Components 允许你标记数据，甚至将 UI 的部分标记为可缓存，这会将它们与页面的静态部分一起包含在预渲染阶段中。</p>
<h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p>当用户访问路由时：</p>
<ol>
<li><strong>服务器发送静态外壳</strong>：包含缓存内容，确保快速初始加载</li>
<li><strong>动态部分显示 fallback</strong>：包裹在 <code>Suspense</code> 边界中的动态部分在外壳中显示 fallback UI</li>
<li><strong>动态内容流式传输</strong>：只有动态部分渲染以替换其 fallback，并行流式传输</li>
<li><strong>缓存的动态数据包含在外壳中</strong>：通过 <code>use cache</code> 缓存的原本动态的数据可以包含在初始外壳中</li>
</ol>
<p><img src="https://h8dxkfmaphn8o0p3.public.blob.vercel-storage.com/learn/light/thinking-in-ppr.png" alt="PPR 工作流程 - next.js官方图片"></p>
<blockquote>
<p><strong>官方视频</strong>: <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=MTcPrTIBkpA">Why PPR and how it works (10 分钟)</a></p>
</blockquote>
<hr>
<h2 id="核心工作原理"><a href="#核心工作原理" class="headerlink" title="核心工作原理"></a>核心工作原理</h2><p>Cache Components 提供三个关键工具来控制渲染：</p>
<h3 id="1-Suspense-for-Runtime-Data（运行时数据）"><a href="#1-Suspense-for-Runtime-Data（运行时数据）" class="headerlink" title="1. Suspense for Runtime Data（运行时数据）"></a>1. Suspense for Runtime Data（运行时数据）</h3><p>某些数据仅在实际用户发出请求时在运行时可用。</p>
<p><strong>运行时 API 包括</strong>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/cookies"><code>cookies()</code></a> - 访问 Cookie</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/headers"><code>headers()</code></a> - 访问请求头</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/file-conventions/page#searchparams-optional"><code>searchParams</code></a> - URL 查询参数</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/file-conventions/page#params-optional"><code>params</code></a> - 动态路由参数（除非通过 <code>generateStaticParams</code> 提供）</li>
</ul>
<p><strong>使用方法</strong>：将使用这些 API 的组件包裹在 <code>Suspense</code> 边界中，以便页面的其余部分可以预渲染为静态外壳。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; cookies &#125; <span class="keyword">from</span> <span class="string">&quot;next/headers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* 静态部分 - 立即显示 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">header</span>&gt;</span>My App<span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;/* 动态部分 - 需要 Suspense */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading user...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">UserInfo</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">UserInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> db.<span class="property">users</span>.<span class="title function_">findUnique</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: userId &#125; &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Welcome, &#123;user.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Suspense-for-Dynamic-Data（动态数据）"><a href="#2-Suspense-for-Dynamic-Data（动态数据）" class="headerlink" title="2. Suspense for Dynamic Data（动态数据）"></a>2. Suspense for Dynamic Data（动态数据）</h3><p>动态数据如 <code>fetch</code> 调用或数据库查询可能在请求之间发生变化，但不是用户特定的。</p>
<p><strong>动态数据模式包括</strong>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/fetch"><code>fetch()</code></a> 请求</li>
<li>数据库查询（<code>db.query(...)</code>）</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/connection"><code>connection()</code></a> - 元动态 API</li>
</ul>
<p><strong>使用方法</strong>：将使用这些的组件包裹在 <code>Suspense</code> 边界中以启用流式传输。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Products<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading products...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ProductList</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ProductList</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> products = <span class="keyword">await</span> db.<span class="property">products</span>.<span class="title function_">findMany</span>();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;products.map((p) =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;p.id&#125;</span>&gt;</span>&#123;p.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Cached-Data-with-use-cache（缓存数据）"><a href="#3-Cached-Data-with-use-cache（缓存数据）" class="headerlink" title="3. Cached Data with use cache（缓存数据）"></a>3. Cached Data with <code>use cache</code>（缓存数据）</h3><p>将 <code>use cache</code> 添加到任何 Server Component 以使其缓存并包含在预渲染的外壳中。</p>
<p><strong>限制</strong>：</p>
<ul>
<li>❌ 不能在缓存组件内使用运行时 API（cookies、headers 等）</li>
<li>✅ 可以标记工具函数为 <code>use cache</code> 并从 Server Components 调用</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getProducts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> db.<span class="title function_">query</span>(<span class="string">&quot;SELECT * FROM products&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="使用-Suspense-边界"><a href="#使用-Suspense-边界" class="headerlink" title="使用 Suspense 边界"></a>使用 Suspense 边界</h2><p>React <a target="_blank" rel="noopener" href="https://react.dev/reference/react/Suspense">Suspense</a> 边界让你定义当它包裹动态或运行时数据时使用什么 fallback UI。</p>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这会被预渲染<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Skeleton</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">DynamicContent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">DynamicContent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;http://api.cms.com/posts&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; posts &#125; = <span class="keyword">await</span> res.<span class="title function_">json</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;/* 渲染文章 */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>工作原理</strong>：</p>
<ul>
<li>边界外的内容（包括 fallback UI）被预渲染为静态外壳</li>
<li>边界内的内容在准备好时流式传输</li>
</ul>
<p>在构建时，Next.js 预渲染静态内容和 <code>fallback</code> UI，而动态内容被推迟到用户请求路由时。</p>
<blockquote>
<p><strong>注意</strong>：将组件包裹在 <code>Suspense</code> 中不会使其动态；你的 API 使用决定了这一点。<code>Suspense</code> 作为封装动态内容和启用流式传输的边界。</p>
</blockquote>
<h3 id="缺少-Suspense-边界时的错误"><a href="#缺少-Suspense-边界时的错误" class="headerlink" title="缺少 Suspense 边界时的错误"></a>缺少 Suspense 边界时的错误</h3><p>Cache Components 强制要求动态代码必须包裹在 <code>Suspense</code> 边界中。如果忘记，你会看到错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Uncached data was accessed outside of &lt;Suspense&gt;</span><br><span class="line"></span><br><span class="line">This delays the entire page from rendering, resulting in a slow user</span><br><span class="line">experience. Next.js uses this error to ensure your app loads instantly</span><br><span class="line">on every navigation.</span><br><span class="line"></span><br><span class="line">To fix this, you can either:</span><br><span class="line">- Wrap the component in a &lt;Suspense&gt; boundary</span><br><span class="line">- Move the asynchronous await into a Cache Component(&quot;use cache&quot;)</span><br></pre></td></tr></table></figure>

<p><strong>修复方法</strong>：</p>
<ol>
<li><strong>添加 Suspense 边界</strong>（推荐）</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Loading</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">DynamicComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>使用 <code>use cache</code></strong> 缓存工作</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">DynamicComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;data&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="流式传输工作原理"><a href="#流式传输工作原理" class="headerlink" title="流式传输工作原理"></a>流式传输工作原理</h3><p>流式传输将路由分割成块，并在准备好时逐步流式传输到客户端。这允许用户在整个内容完成渲染之前立即看到页面的部分内容。</p>
<p><img src="https://h8dxkfmaphn8o0p3.public.blob.vercel-storage.com/docs/light/server-rendering-with-streaming.png" alt="流式传输示意图 - next.js官方图片"></p>
<p>通过部分预渲染，初始 UI 可以立即发送到浏览器，而动态部分则在渲染时流式传输。这减少了 UI 显示时间，并可能减少总请求时间。</p>
<p><img src="https://h8dxkfmaphn8o0p3.public.blob.vercel-storage.com/docs/light/sequential-parallel-data-fetching.png" alt="流式传输并行化 - next.js官方图片"></p>
<p>为了减少网络开销，完整响应（包括静态 HTML 和流式动态部分）在<strong>单个 HTTP 请求</strong>中发送。这避免了额外的往返，并提高了初始加载和整体性能。</p>
<hr>
<h2 id="使用-use-cache"><a href="#使用-use-cache" class="headerlink" title="使用 use cache"></a>使用 use cache</h2><p>虽然 <code>Suspense</code> 边界管理动态内容，但 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/directives/use-cache"><code>use cache</code></a> 指令可用于缓存不经常更改的数据或计算。</p>
<h3 id="基本用法-1"><a href="#基本用法-1" class="headerlink" title="基本用法"></a>基本用法</h3><p>将 <code>use cache</code> 添加到页面、组件或异步函数，并使用 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/cacheLife"><code>cacheLife</code></a> 定义生命周期：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; cacheLife &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://api.example.com/data&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;/* 渲染数据 */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="cacheLife-预定义配置"><a href="#cacheLife-预定义配置" class="headerlink" title="cacheLife 预定义配置"></a>cacheLife 预定义配置</h3><table>
<thead>
<tr>
<th>Profile</th>
<th>Use Case</th>
<th>stale</th>
<th>revalidate</th>
<th>expire</th>
</tr>
</thead>
<tbody><tr>
<td><code>&#39;default&#39;</code></td>
<td>Standard content</td>
<td>5 minutes</td>
<td>15 minutes</td>
<td>1 year</td>
</tr>
<tr>
<td><code>&#39;seconds&#39;</code></td>
<td>Real-time data</td>
<td>30 seconds</td>
<td>1 second</td>
<td>1 minute</td>
</tr>
<tr>
<td><code>&#39;minutes&#39;</code></td>
<td>Frequently updated content</td>
<td>5 minutes</td>
<td>1 minute</td>
<td>1 hour</td>
</tr>
<tr>
<td><code>&#39;hours&#39;</code></td>
<td>Content updated multiple times per day</td>
<td>5 minutes</td>
<td>1 hour</td>
<td>1 day</td>
</tr>
<tr>
<td><code>&#39;days&#39;</code></td>
<td>Content updated daily</td>
<td>5 minutes</td>
<td>1 day</td>
<td>1 week</td>
</tr>
<tr>
<td><code>&#39;weeks&#39;</code></td>
<td>Content updated weekly</td>
<td>5 minutes</td>
<td>1 week</td>
<td>30 days</td>
</tr>
<tr>
<td><code>&#39;max&#39;</code></td>
<td>Stable content that rarely changes</td>
<td>5 minutes</td>
<td>30 days</td>
<td>1 year</td>
</tr>
</tbody></table>
<p>expire 要大于 stale，stable 不要小于 30s（不然缓存没意义）。</p>
<p><strong>自定义配置</strong>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; cacheLife &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">CustomCache</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(&#123;</span><br><span class="line">    <span class="attr">stale</span>: <span class="number">60</span>, <span class="comment">// 60 秒内视为新鲜</span></span><br><span class="line">    <span class="attr">revalidate</span>: <span class="number">300</span>, <span class="comment">// 300 秒后后台重新验证</span></span><br><span class="line">    <span class="attr">expire</span>: <span class="number">3600</span>, <span class="comment">// 3600 秒后过期</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://api.example.com/data&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="构建时与运行时行为"><a href="#构建时与运行时行为" class="headerlink" title="构建时与运行时行为"></a>构建时与运行时行为</h3><h4 id="use-cache-at-build-time（构建时）"><a href="#use-cache-at-build-time（构建时）" class="headerlink" title="use cache at build time（构建时）"></a>use cache at build time（构建时）</h4><p>当在 layout 或 page 顶部使用 <code>use cache</code> 时，路由段会被预渲染，允许之后重新验证。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/products/page.tsx</span></span><br><span class="line"><span class="string">&quot;use cache&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ProductsPage</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> products = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://api.example.com/products&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span></span><br><span class="line">    res.<span class="title function_">json</span>()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;/* 渲染产品 */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>✅ 路由段在构建时预渲染</li>
<li>✅ 可以后续 revalidated</li>
<li>❌ <strong>不能与运行时数据一起使用</strong>（cookies、headers）</li>
</ul>
<p><strong>重要限制</strong>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use cache&quot;</span>;</span><br><span class="line"><span class="comment">// ❌ 错误：use cache 不能访问运行时数据</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>; <span class="comment">// 运行时错误！</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;userId&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：如果需要缓存依赖 cookies、headers 或 search params 的内容，请使用 <code>&#39;use cache: private&#39;</code> 代替。</p>
</blockquote>
<h4 id="use-cache-at-runtime（运行时）"><a href="#use-cache-at-runtime（运行时）" class="headerlink" title="use cache at runtime（运行时）"></a>use cache at runtime（运行时）</h4><p>当应用运行时，<code>use cache</code> 在服务器和客户端的行为：</p>
<p><strong>服务器端</strong>：</p>
<ul>
<li>单个组件或函数的缓存条目会缓存在内存中</li>
<li>多个请求可以共享这些缓存条目</li>
</ul>
<p><strong>客户端</strong>：</p>
<ul>
<li>从服务器缓存返回的任何内容会存储在浏览器内存中</li>
<li>持续整个会话或直到重新验证</li>
<li>页面刷新或导航离开会清除缓存</li>
</ul>
<p><strong>示例</strong>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务器端缓存的工具函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getCachedProducts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> db.<span class="property">products</span>.<span class="title function_">findMany</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 第一次调用：查询数据库 → 缓存在服务器内存</span></span><br><span class="line">  <span class="keyword">const</span> products = <span class="keyword">await</span> <span class="title function_">getCachedProducts</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后续请求：直接从服务器内存缓存返回</span></span><br><span class="line">  <span class="comment">// 客户端收到的数据也会缓存在浏览器内存中</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;/* 渲染产品 */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>缓存生命周期</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">构建时：</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│ 1. 预渲染路由段</span><br><span class="line">│ 2. 生成静态 HTML</span><br><span class="line">│ 3. 缓存结果供后续请求使用</span><br><span class="line">└─────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">运行时（服务器）：</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│ 请求 1 → 执行函数 → 缓存结果（内存）</span><br><span class="line">│ 请求 2 → 命中缓存 → 返回缓存结果</span><br><span class="line">│ 请求 3 → 命中缓存 → 返回缓存结果</span><br><span class="line">│ ...直到重新验证或过期</span><br><span class="line">└─────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">运行时（客户端）：</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│ 1. 接收服务器缓存的数据</span><br><span class="line">│ 2. 存储在浏览器内存</span><br><span class="line">│ 3. 导航时复用（同一会话）</span><br><span class="line">│ 4. session过期或者revalidated → 清除</span><br><span class="line">└─────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a>使用限制</h3><h4 id="1-参数必须可序列化"><a href="#1-参数必须可序列化" class="headerlink" title="1. 参数必须可序列化"></a>1. 参数必须可序列化</h4><p>与 Server Actions 类似，缓存函数的参数必须是可序列化的。这意味着你可以传递原始类型、普通对象和数组，但不能传递类实例、函数或其他复杂类型。</p>
<h4 id="2-可接受但不能内省不可序列化的值"><a href="#2-可接受但不能内省不可序列化的值" class="headerlink" title="2. 可接受但不能内省不可序列化的值"></a>2. 可接受但不能内省不可序列化的值</h4><p>你可以接受不可序列化的值作为参数，只要你不内省它们。但是，你可以返回它们。这允许像缓存组件接受 Server 或 Client Components 作为 children 的模式：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReactNode</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">CachedWrapper</span>(<span class="params">&#123; children &#125;: &#123; children: ReactNode &#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="comment">// 不要内省 children，只是传递它</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;wrapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">header</span>&gt;</span>Cached Header<span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：不可序列化的参数（如 JSX、函数）不会成为缓存键的一部分。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getCached</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">id</span>: <span class="built_in">number</span>, <span class="comment">// ✅ 可序列化 → 包含在缓存键中</span></span></span><br><span class="line"><span class="params">  <span class="attr">children</span>: <span class="title class_">ReactNode</span>, <span class="comment">// ❌ 不可序列化 → 不包含在缓存键中</span></span></span><br><span class="line"><span class="params">  <span class="attr">callback</span>: () =&gt; <span class="built_in">void</span> <span class="comment">// ❌ 不可序列化 → 不包含在缓存键中</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; id, <span class="attr">content</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相同 id，不同 children → 缓存命中</span></span><br><span class="line"><span class="keyword">const</span> result1 = <span class="keyword">await</span> <span class="title function_">getCached</span>(<span class="number">1</span>, <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>A<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>, <span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line"><span class="keyword">const</span> result2 = <span class="keyword">await</span> <span class="title function_">getCached</span>(<span class="number">1</span>, <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>B<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>, <span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line"><span class="comment">// result1 和 result2 来自同一缓存（因为 id 相同）</span></span><br></pre></td></tr></table></figure>

<h4 id="3-避免传递动态输入"><a href="#3-避免传递动态输入" class="headerlink" title="3. 避免传递动态输入"></a>3. 避免传递动态输入</h4><p>除非你避免内省它们，否则不能将动态或运行时数据传递到 <code>use cache</code> 函数中。传递来自 <code>cookies()</code>、<code>headers()</code> 或其他运行时 API 的值作为参数将导致错误，因为无法在预渲染时确定缓存键。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：传递运行时数据</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">BadExample</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>; <span class="comment">// 运行时错误！</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;userId&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：不在缓存中使用运行时 API</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">GoodExample</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 无 &#x27;use cache&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;userId&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="标记和重新验证"><a href="#标记和重新验证" class="headerlink" title="标记和重新验证"></a>标记和重新验证</h3><p>使用 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/cacheTag"><code>cacheTag</code></a> 标记缓存数据，并在突变后使用 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/updateTag"><code>updateTag</code></a> 或 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/revalidateTag"><code>revalidateTag</code></a> 重新验证。</p>
<h4 id="使用-updateTag（立即更新）"><a href="#使用-updateTag（立即更新）" class="headerlink" title="使用 updateTag（立即更新）"></a>使用 updateTag（立即更新）</h4><p>当你需要在同一请求中过期并立即刷新缓存数据时使用 <code>updateTag</code>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use server&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; cacheTag, updateTag &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getCart</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheTag</span>(<span class="string">&quot;cart&quot;</span>);</span><br><span class="line">  <span class="comment">// 获取数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">updateCart</span>(<span class="params"><span class="attr">itemId</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use server&quot;</span>;</span><br><span class="line">  <span class="comment">// 使用 itemId 写入数据</span></span><br><span class="line">  <span class="comment">// 更新用户购物车</span></span><br><span class="line">  <span class="title function_">updateTag</span>(<span class="string">&quot;cart&quot;</span>); <span class="comment">// 立即使缓存失效</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用场景</strong>：</p>
<ul>
<li>✅ 需要用户立即看到更新（如购物车）</li>
<li>✅ Read-your-own-writes 模式</li>
<li>✅ Server Actions 专用</li>
</ul>
<h4 id="使用-revalidateTag（后台重新验证）"><a href="#使用-revalidateTag（后台重新验证）" class="headerlink" title="使用 revalidateTag（后台重新验证）"></a>使用 revalidateTag（后台重新验证）</h4><p>当你想要仅使正确标记的缓存条目失效并采用 stale-while-revalidate 行为时使用 <code>revalidateTag</code>。这对于可以容忍最终一致性的静态内容是理想的。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use server&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; cacheTag, revalidateTag &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheTag</span>(<span class="string">&quot;posts&quot;</span>);</span><br><span class="line">  <span class="comment">// 获取数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createPost</span>(<span class="params"><span class="attr">post</span>: <span class="title class_">FormData</span></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use server&quot;</span>;</span><br><span class="line">  <span class="comment">// 使用 FormData 写入数据</span></span><br><span class="line">  <span class="title function_">revalidateTag</span>(<span class="string">&quot;posts&quot;</span>, <span class="string">&quot;max&quot;</span>); <span class="comment">// 后台重新验证</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用场景</strong>：</p>
<ul>
<li>✅ 可以容忍短暂过期数据（如博客文章、CMS 内容）</li>
<li>✅ 避免”惊群效应”（多个请求同时触发数据重新生成）</li>
<li>✅ Server Actions + Route Handlers</li>
</ul>
<p><strong>为什么推荐使用 <code>&#39;max&#39;</code> 配置</strong>：</p>
<p><code>revalidateTag(tag, &#39;max&#39;)</code> 使用 <strong>Stale-While-Revalidate (SWR)</strong> 策略：</p>
<ol>
<li>调用 <code>revalidateTag</code></li>
<li>缓存标记为 “stale”（过期但仍可用）</li>
<li>下一个请求：<ul>
<li>✅ 立即返回过期缓存（快速响应）</li>
<li>🔄 同时后台触发重新验证</li>
</ul>
</li>
<li>再下一个请求：<ul>
<li>✅ 返回更新后的新数据</li>
</ul>
</li>
</ol>
<p><strong>优势</strong>：</p>
<ul>
<li>用户不会遇到”等待数据重新生成”的延迟</li>
<li>避免高流量时的并发数据库查询</li>
<li>平滑的数据更新过渡</li>
</ul>
<hr>
<h2 id="启用-Cache-Components"><a href="#启用-Cache-Components" class="headerlink" title="启用 Cache Components"></a>启用 Cache Components</h2><p>在 <code>next.config.ts</code> 中添加 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/config/next-config-js/cacheComponents"><code>cacheComponents</code></a> 选项：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next.config.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">NextConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;next&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">nextConfig</span>: <span class="title class_">NextConfig</span> = &#123;</span><br><span class="line">  <span class="attr">cacheComponents</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> nextConfig;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next.config.js</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">import(&#x27;next&#x27;).NextConfig</span>&#125; */</span></span><br><span class="line"><span class="keyword">const</span> nextConfig = &#123;</span><br><span class="line">  <span class="attr">cacheComponents</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = nextConfig;</span><br></pre></td></tr></table></figure>

<h3 id="Navigation-with-Cache-Components"><a href="#Navigation-with-Cache-Components" class="headerlink" title="Navigation with Cache Components"></a>Navigation with Cache Components</h3><p>当启用 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/config/next-config-js/cacheComponents"><code>cacheComponents</code></a> 标志时，Next.js 使用 React 的 <a target="_blank" rel="noopener" href="https://react.dev/reference/react/Activity"><code>&lt;Activity&gt;</code></a> 组件在客户端导航期间保留组件状态。</p>
<p>工作方式：</p>
<ul>
<li><strong>状态保留</strong>：导航离开时不卸载前一个路由，而是设置 Activity 模式为 <a target="_blank" rel="noopener" href="https://react.dev/reference/react/Activity#activity"><code>&quot;hidden&quot;</code></a></li>
<li><strong>导航回退</strong>：导航回来时，前一个路由及其状态完整保留</li>
<li><strong>效果清理</strong>：路由隐藏时清理效果，再次可见时重新创建</li>
</ul>
<p><strong>好处</strong>：通过在用户前后导航时维护 UI 状态（表单输入、展开的部分）来改善导航体验。</p>
<blockquote>
<p><strong>注意</strong>：Next.js 使用启发式方法保持几个最近访问的路由为 <a target="_blank" rel="noopener" href="https://react.dev/reference/react/Activity#activity"><code>&quot;hidden&quot;</code></a>，而较旧的路由从 DOM 中移除以防止过度增长。</p>
</blockquote>
<hr>
<h2 id="从旧版本迁移"><a href="#从旧版本迁移" class="headerlink" title="从旧版本迁移"></a>从旧版本迁移</h2><p>启用 Cache Components 后，几个 Route Segment Config 选项不再需要或不受支持。以下是变化和迁移方法：</p>
<h3 id="1-dynamic-force-dynamic"><a href="#1-dynamic-force-dynamic" class="headerlink" title="1. dynamic = &quot;force-dynamic&quot;"></a>1. <code>dynamic = &quot;force-dynamic&quot;</code></h3><p><strong>不再需要</strong>。启用 Cache Components 后，所有页面默认是动态的，因此此配置不必要。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 之前 - 不再需要</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> dynamic = <span class="string">&quot;force-dynamic&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 之后 - 直接删除，页面默认是动态的</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-dynamic-force-static"><a href="#2-dynamic-force-static" class="headerlink" title="2. dynamic = &quot;force-static&quot;"></a>2. <code>dynamic = &quot;force-static&quot;</code></h3><p><strong>用 <code>use cache</code> 替代</strong>。你必须为关联路由的每个 Layout 和 Page 添加 <code>use cache</code>。</p>
<blockquote>
<p>16.0.1 版本实际测试发现<code>cache-control</code>变成<code>no-store</code>了，关闭 cacheComponent 会出现 s-maxage 和 swr，行为不一致。</p>
</blockquote>
<blockquote>
<p><strong>注意</strong>：<code>force-static</code> 之前允许使用运行时 API 如 <code>cookies()</code>，但现在不再支持。如果你添加 <code>use cache</code> 并看到与运行时数据相关的错误，你必须移除运行时 API 的使用。</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 之前</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> dynamic = <span class="string">&quot;force-static&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://api.example.com/data&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 之后 - 使用 &#x27;use cache&#x27; 替代</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://api.example.com/data&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-revalidate"><a href="#3-revalidate" class="headerlink" title="3. revalidate"></a>3. <code>revalidate</code></h3><p><strong>用 <code>cacheLife</code> 替代</strong>。使用 <code>cacheLife</code> 函数定义缓存持续时间，而不是路由段配置。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 之前</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> revalidate = <span class="number">3600</span>; <span class="comment">// 1 小时</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 之后 - 使用 cacheLife</span></span><br><span class="line"><span class="keyword">import</span> &#123; cacheLife &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-fetchCache"><a href="#4-fetchCache" class="headerlink" title="4. fetchCache"></a>4. <code>fetchCache</code></h3><p><strong>不再需要</strong>。使用 <code>use cache</code> 时，缓存范围内的所有数据获取都会自动缓存，使 <code>fetchCache</code> 不必要。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 之前</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchCache = <span class="string">&quot;force-cache&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 之后 - 使用 &#x27;use cache&#x27; 控制缓存行为</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="comment">// 这里的所有 fetch 都被缓存</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-runtime-edge"><a href="#5-runtime-edge" class="headerlink" title="5. runtime = &#39;edge&#39;"></a>5. <code>runtime = &#39;edge&#39;</code></h3><p><strong>不支持</strong>。Cache Components 需要 Node.js 运行时，使用 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/edge">Edge Runtime</a> 会抛出错误。</p>
<hr>
<h2 id="实战示例"><a href="#实战示例" class="headerlink" title="实战示例"></a>实战示例</h2><h3 id="示例-1-动态-API-使用"><a href="#示例-1-动态-API-使用" class="headerlink" title="示例 1: 动态 API 使用"></a>示例 1: 动态 API 使用</h3><p>当访问运行时 API 如 <code>cookies()</code> 时，Next.js 只会预渲染此组件上方的 fallback UI。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/user.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123; cookies &#125; <span class="keyword">from</span> <span class="string">&quot;next/headers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">User</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> session = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;session&quot;</span>)?.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>User: &#123;session&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>页面组件</strong>（需要 Suspense）：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/page.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./user&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">section</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这会被预渲染<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading user...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">User</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例-2-传递动态-Props"><a href="#示例-2-传递动态-Props" class="headerlink" title="示例 2: 传递动态 Props"></a>示例 2: 传递动态 Props</h3><p>组件只有在访问值时才选择动态渲染。例如，如果你从 <code>&lt;Page /&gt;</code> 组件读取 <code>searchParams</code>，你可以将此值作为 prop 转发到另一个组件：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/page.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Table</span>, <span class="title class_">TableSkeleton</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./table&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  searchParams,</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  searchParams: <span class="built_in">Promise</span>&lt;&#123; sort: <span class="built_in">string</span> &#125;&gt;;</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">section</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这会被预渲染<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">TableSkeleton</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Table</span> <span class="attr">searchParams</span>=<span class="string">&#123;searchParams.then((search)</span> =&gt;</span> search.sort)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Table 组件</strong>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/table.tsx</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Table</span>(<span class="params">&#123; sortPromise &#125;: &#123; sortPromise: <span class="built_in">Promise</span>&lt;<span class="built_in">string</span>&gt; &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> sort = (<span class="keyword">await</span> sortPromise) === <span class="string">&quot;true&quot;</span>;</span><br><span class="line">  <span class="comment">// 访问值使组件动态，但页面的其余部分会被预渲染</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;/* 渲染表格 */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例-3-Route-Handlers-with-Cache-Components"><a href="#示例-3-Route-Handlers-with-Cache-Components" class="headerlink" title="示例 3: Route Handlers with Cache Components"></a>示例 3: Route Handlers with Cache Components</h3><p><code>GET</code> Route Handlers 遵循与应用中正常 UI 路由相同的模型。它们默认是动态的，可以在确定性时预渲染，你可以使用 <code>use cache</code> 在缓存响应中包含更多动态数据。</p>
<p><strong>动态示例</strong>（每次请求返回不同数字）：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/api/random-number/route.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">GET</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">randomNumber</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>(),</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>静态示例</strong>（在构建时预渲染）：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/api/project-info/route.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">GET</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">projectName</span>: <span class="string">&quot;Next.js&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>缓存动态数据示例</strong>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/api/products/route.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; cacheLife &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">GET</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> products = <span class="keyword">await</span> <span class="title function_">getProducts</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">json</span>(products);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getProducts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>); <span class="comment">// 最多每小时查询一次数据库</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> db.<span class="title function_">query</span>(<span class="string">&quot;SELECT * FROM products&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：</p>
<ul>
<li><code>use cache</code> 不能直接在 Route Handler 主体中使用；提取到辅助函数</li>
<li>缓存响应根据 <code>cacheLife</code> 在新请求到达时重新验证</li>
<li>使用运行时 API 如 <code>cookies()</code> 或 <code>headers()</code>，或调用 <code>connection()</code>，始终推迟到请求时（无预渲染）</li>
</ul>
</blockquote>
<h3 id="示例-4-完整电商页面"><a href="#示例-4-完整电商页面" class="headerlink" title="示例 4: 完整电商页面"></a>示例 4: 完整电商页面</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/products/[id]/page.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; cacheLife, cacheTag &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; cookies &#125; <span class="keyword">from</span> <span class="string">&quot;next/headers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ProductPage</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  params,</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  params: <span class="built_in">Promise</span>&lt;&#123; id: <span class="built_in">string</span> &#125;&gt;;</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* 静态导航 - 立即显示 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/products&quot;</span>&gt;</span>Products<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;/* 产品信息 - 公共缓存，1 小时 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">ProductSkeleton</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ProductInfo</span> <span class="attr">params</span>=<span class="string">&#123;params&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;/* 用户购物车 - 动态，无缓存 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">CartSkeleton</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">UserCart</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;/* 推荐商品 - 公共缓存，1 天 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">RecommendationsSkeleton</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Recommendations</span> <span class="attr">params</span>=<span class="string">&#123;params&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 产品信息 - 缓存 1 小时</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ProductInfo</span>(<span class="params">&#123; params &#125;: &#123; params: <span class="built_in">Promise</span>&lt;&#123; id: <span class="built_in">string</span> &#125;&gt; &#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line">  <span class="title function_">cacheTag</span>(<span class="string">&quot;products&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = <span class="keyword">await</span> params;</span><br><span class="line">  <span class="keyword">const</span> product = <span class="keyword">await</span> db.<span class="property">products</span>.<span class="title function_">findUnique</span>(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;product.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;product.description&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Price: $&#123;product.price&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户购物车 - 动态，每次请求获取</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">UserCart</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">const</span> cart = <span class="keyword">await</span> db.<span class="property">carts</span>.<span class="title function_">findUnique</span>(&#123;</span><br><span class="line">    <span class="attr">where</span>: &#123; userId &#125;,</span><br><span class="line">    <span class="attr">include</span>: &#123; <span class="attr">items</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Your Cart<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;cart.items.length&#125; items<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 推荐商品 - 缓存 1 天</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Recommendations</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  params,</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  params: <span class="built_in">Promise</span>&lt;&#123; id: <span class="built_in">string</span> &#125;&gt;;</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;days&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = <span class="keyword">await</span> params;</span><br><span class="line">  <span class="keyword">const</span> recommendations = <span class="keyword">await</span> <span class="title function_">getRecommendations</span>(id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>You might also like<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;recommendations.map((r) =&gt; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;r.id&#125;</span>&gt;</span>&#123;r.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ))&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="1-根据数据特性选择策略"><a href="#1-根据数据特性选择策略" class="headerlink" title="1. 根据数据特性选择策略"></a>1. 根据数据特性选择策略</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 公共、变化不频繁的数据 → use cache</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getCategories</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;days&quot;</span>);</span><br><span class="line">  <span class="title function_">cacheTag</span>(<span class="string">&quot;categories&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> db.<span class="property">categories</span>.<span class="title function_">findMany</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 用户特定数据 → 动态渲染（无缓存）</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUserProfile</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> db.<span class="property">users</span>.<span class="title function_">findUnique</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: userId &#125; &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 实时数据 → 动态渲染 + connection()</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getLiveData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">connection</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://api.example.com/live&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-合理使用-Suspense-嵌套"><a href="#2-合理使用-Suspense-嵌套" class="headerlink" title="2. 合理使用 Suspense 嵌套"></a>2. 合理使用 Suspense 嵌套</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* 外层：页面级 Suspense */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">PageSkeleton</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">PageContent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">PageContent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">StaticHeader</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;/* 内层：组件级 Suspense，细粒度控制 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">UserSkeleton</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">UserInfo</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">ProductsSkeleton</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ProductList</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-缓存粒度策略"><a href="#3-缓存粒度策略" class="headerlink" title="3. 缓存粒度策略"></a>3. 缓存粒度策略</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 好：细粒度缓存</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ProductCard</span>(<span class="params">&#123; id &#125;: &#123; id: <span class="built_in">string</span> &#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line">  <span class="title function_">cacheTag</span>(<span class="string">&quot;products&quot;</span>, <span class="string">`product-<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> product = <span class="keyword">await</span> db.<span class="property">products</span>.<span class="title function_">findUnique</span>(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;product.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ProductList</span>(<span class="params">&#123; ids &#125;: &#123; ids: <span class="built_in">string</span>[] &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;ids.map((id) =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ProductCard</span> <span class="attr">key</span>=<span class="string">&#123;id&#125;</span> <span class="attr">id</span>=<span class="string">&#123;id&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 差：粗粒度缓存（不灵活）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ProductList</span>(<span class="params">&#123; ids &#125;: &#123; ids: <span class="built_in">string</span>[] &#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>; <span class="comment">// 整个列表作为一个缓存</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> products = <span class="keyword">await</span> db.<span class="property">products</span>.<span class="title function_">findMany</span>(&#123;</span><br><span class="line">    <span class="attr">where</span>: &#123; <span class="attr">id</span>: &#123; <span class="attr">in</span>: ids &#125; &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;products.map((p) =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">&#123;p.id&#125;</span>&gt;</span>&#123;p.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>为什么细粒度更好</strong>：</p>
<ul>
<li>单个产品更新时，只需要使一个缓存失效</li>
<li>不同产品可以有不同的缓存策略</li>
<li>更容易调试和维护</li>
</ul>
<h3 id="4-多级缓存标签"><a href="#4-多级缓存标签" class="headerlink" title="4. 多级缓存标签"></a>4. 多级缓存标签</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ProductDetails</span>(<span class="params">&#123; id &#125;: &#123; id: <span class="built_in">string</span> &#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用多个标签便于不同级别的失效</span></span><br><span class="line">  <span class="title function_">cacheTag</span>(</span><br><span class="line">    <span class="string">&quot;products&quot;</span>, <span class="comment">// 所有产品</span></span><br><span class="line">    <span class="string">`product-<span class="subst">$&#123;id&#125;</span>`</span>, <span class="comment">// 特定产品</span></span><br><span class="line">    <span class="string">`category-electronics`</span> <span class="comment">// 产品类别</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> product = <span class="keyword">await</span> db.<span class="property">products</span>.<span class="title function_">findUnique</span>(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;product.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 失效策略：</span></span><br><span class="line"><span class="comment">// revalidateTag(`product-$&#123;id&#125;`, &#x27;max&#x27;)      // 仅失效特定产品</span></span><br><span class="line"><span class="comment">// revalidateTag(&#x27;category-electronics&#x27;, &#x27;max&#x27;) // 失效整个类别</span></span><br><span class="line"><span class="comment">// revalidateTag(&#x27;products&#x27;, &#x27;max&#x27;)            // 失效所有产品</span></span><br></pre></td></tr></table></figure>

<h3 id="5-generateStaticParams-最佳实践"><a href="#5-generateStaticParams-最佳实践" class="headerlink" title="5. generateStaticParams 最佳实践"></a>5. generateStaticParams 最佳实践</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 推荐：预生成热门内容，其余按需生成</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">generateStaticParams</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 只预生成前 20 个热门产品</span></span><br><span class="line">  <span class="keyword">const</span> topProducts = <span class="keyword">await</span> db.<span class="property">products</span></span><br><span class="line">    .<span class="title function_">orderBy</span>(<span class="string">&quot;views&quot;</span>, <span class="string">&quot;desc&quot;</span>)</span><br><span class="line">    .<span class="title function_">limit</span>(<span class="number">20</span>)</span><br><span class="line">    .<span class="title function_">select</span>(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> topProducts.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> (&#123; <span class="attr">id</span>: p.<span class="property">id</span> &#125;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ProductPage</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  params,</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  params: <span class="built_in">Promise</span>&lt;&#123; id: <span class="built_in">string</span> &#125;&gt;;</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line">  <span class="title function_">cacheTag</span>(<span class="string">&quot;products&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = <span class="keyword">await</span> params;</span><br><span class="line">  <span class="keyword">const</span> product = <span class="keyword">await</span> db.<span class="property">products</span>.<span class="title function_">findUnique</span>(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;product.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>策略说明</strong>：</p>
<ul>
<li><strong>低基数参数</strong>（如分类、语言）：预生成所有值</li>
<li><strong>高基数参数</strong>（如产品 ID）：只预生成热门值</li>
<li><strong>按需生成</strong> + <strong>缓存</strong> &#x3D; ISR 效果</li>
</ul>
<hr>
<h2 id="和-Next-intl-结合"><a href="#和-Next-intl-结合" class="headerlink" title="和 Next-intl 结合"></a>和 Next-intl 结合</h2><p>现在使用 next-intl 可能会导致报各种缺少 Suspense 边界的错，这个的核心是在不指定 locale 的情况下，使用<code>getTranslate</code>,<code>useTranslate</code>,<code>&lt;Link&gt;</code>(next-intl 的 Link)会去读取 header（x-next-intl-locale），相当于这个库会自己去用 dynamic api。</p>
<p>要解决很简单，拿到 locale 之后塞到<code>setRequestLocale</code>里或者直接塞到各个的 locale 参数里。</p>
<p>这个和解决 static 渲染类似。</p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://next-intl.dev/docs/routing/setup#add-setrequestlocale-to-all-relevant-layouts-and-pages">Add setRequestLocale to all relevant layouts and pages</a></p>
<h2 id="常见错误与解决方案"><a href="#常见错误与解决方案" class="headerlink" title="常见错误与解决方案"></a>常见错误与解决方案</h2><h3 id="错误-1-缺少-Suspense-边界"><a href="#错误-1-缺少-Suspense-边界" class="headerlink" title="错误 1: 缺少 Suspense 边界"></a>错误 1: 缺少 Suspense 边界</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;userId&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误信息：</span></span><br><span class="line"><span class="comment">// Uncached data was accessed outside of &lt;Suspense&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决方案 1: 添加 Suspense</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Loading</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">UserContent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">UserContent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;userId&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决方案 2: 使用 use cache（如果适用）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="comment">// 但注意：不能在 use cache 中使用 cookies()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误-2-在-use-cache-中使用运行时-API"><a href="#错误-2-在-use-cache-中使用运行时-API" class="headerlink" title="错误 2: 在 use cache 中使用运行时 API"></a>错误 2: 在 use cache 中使用运行时 API</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Component</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>; <span class="comment">// 运行时错误！</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;userId&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决方案：移除 use cache，使用 Suspense</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Component</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 无 &#x27;use cache&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> userId = (<span class="keyword">await</span> <span class="title function_">cookies</span>()).<span class="title function_">get</span>(<span class="string">&quot;userId&quot;</span>)?.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;userId&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Loading</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Component</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误-3-Route-Segment-Config-不兼容"><a href="#错误-3-Route-Segment-Config-不兼容" class="headerlink" title="错误 3: Route Segment Config 不兼容"></a>错误 3: Route Segment Config 不兼容</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> revalidate = <span class="number">60</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> dynamic = <span class="string">&quot;force-static&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误信息：</span></span><br><span class="line"><span class="comment">// Route segment config &quot;revalidate&quot; is not compatible with</span></span><br><span class="line"><span class="comment">// `nextConfig.cacheComponents`. Please remove it.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决方案</span></span><br><span class="line"><span class="keyword">import</span> &#123; cacheLife &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(&#123; <span class="attr">revalidate</span>: <span class="number">60</span> &#125;);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误-4-未-await-params-searchParams"><a href="#错误-4-未-await-params-searchParams" class="headerlink" title="错误 4: 未 await params&#x2F;searchParams"></a>错误 4: 未 await params&#x2F;searchParams</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params">&#123; params &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = params.<span class="property">id</span>; <span class="comment">// 类型错误！params 是 Promise</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决方案</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  params,</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  params: <span class="built_in">Promise</span>&lt;&#123; id: <span class="built_in">string</span> &#125;&gt;;</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = <span class="keyword">await</span> params; <span class="comment">// 必须 await</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Product: &#123;id&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误-5-在-Route-Handler-主体中使用-use-cache"><a href="#错误-5-在-Route-Handler-主体中使用-use-cache" class="headerlink" title="错误 5: 在 Route Handler 主体中使用 use cache"></a>错误 5: 在 Route Handler 主体中使用 use cache</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">GET</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>; <span class="comment">// 不能直接在这里使用</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">json</span>(&#123; <span class="attr">data</span>: <span class="string">&quot;...&quot;</span> &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决方案：提取到辅助函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> db.<span class="title function_">query</span>(<span class="string">&quot;SELECT * FROM data&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">GET</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">getData</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">json</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误-6-传递不可序列化的参数到-use-cache"><a href="#错误-6-传递不可序列化的参数到-use-cache" class="headerlink" title="错误 6: 传递不可序列化的参数到 use cache"></a>错误 6: 传递不可序列化的参数到 use cache</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">cachedFunction</span>(<span class="params"><span class="attr">callback</span>: () =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="title function_">callback</span>(); <span class="comment">// 错误：内省不可序列化的参数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决方案 1：不内省，只传递</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">cachedWrapper</span>(<span class="params">&#123; children &#125;: &#123; children: ReactNode &#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>; <span class="comment">// 只传递，不检查</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决方案 2：只接受可序列化参数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">cachedFunction</span>(<span class="params"><span class="attr">data</span>: &#123; id: <span class="built_in">number</span>; name: <span class="built_in">string</span> &#125;</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use cache&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="Q-Cache-Components-是否取代-PPR？"><a href="#Q-Cache-Components-是否取代-PPR？" class="headerlink" title="Q: Cache Components 是否取代 PPR？"></a>Q: Cache Components 是否取代 PPR？</h3><p><strong>A</strong>: 不。Cache Components <strong>实现了</strong> PPR 作为特性。旧的实验性 PPR 标志已被移除，但 PPR 仍然存在。</p>
<ul>
<li><strong>PPR</strong> 提供静态外壳和流式传输基础设施</li>
<li><strong><code>use cache</code></strong> 让你在外壳中包含优化的动态输出</li>
</ul>
<h3 id="Q-我应该首先缓存什么？"><a href="#Q-我应该首先缓存什么？" class="headerlink" title="Q: 我应该首先缓存什么？"></a>Q: 我应该首先缓存什么？</h3><p><strong>A</strong>: 你缓存的内容应该取决于你希望 UI 加载状态是什么。如果数据不依赖运行时数据，并且你可以接受在一段时间内为多个请求提供缓存值，请使用 <code>use cache</code> 和 <code>cacheLife</code> 来描述该行为。</p>
<p>对于具有更新机制的内容管理系统，考虑使用具有较长缓存持续时间的标签，并依赖 <code>revalidateTag</code> 将静态初始 UI 标记为准备重新验证。这种模式允许你提供快速、缓存的响应，同时在内容实际更改时仍然更新内容，而不是提前过期缓存。</p>
<h3 id="Q-如何快速更新缓存内容？"><a href="#Q-如何快速更新缓存内容？" class="headerlink" title="Q: 如何快速更新缓存内容？"></a>Q: 如何快速更新缓存内容？</h3><p><strong>A</strong>: 使用 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/cacheTag"><code>cacheTag</code></a> 标记你的缓存数据，然后触发 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/updateTag"><code>updateTag</code></a> 或 <a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/revalidateTag"><code>revalidateTag</code></a>。</p>
<p><strong>选择指南</strong>：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>使用</th>
<th>行为</th>
</tr>
</thead>
<tbody><tr>
<td>需要立即看到更新</td>
<td><code>updateTag</code></td>
<td>立即过期，同一请求内刷新</td>
</tr>
<tr>
<td>可以容忍短暂过期</td>
<td><code>revalidateTag</code></td>
<td>Stale-while-revalidate，后台更新</td>
</tr>
</tbody></table>
<h3 id="Q-ISR-还支持吗？"><a href="#Q-ISR-还支持吗？" class="headerlink" title="Q: ISR 还支持吗？"></a>Q: ISR 还支持吗？</h3><p><strong>A</strong>: 是的，ISR 功能仍然存在，但 API 已更改：</p>
<ul>
<li>❌ <code>export const revalidate = 60</code></li>
<li>✅ <code>cacheLife(&#123; revalidate: 60 &#125;)</code></li>
</ul>
<p>使用 <code>use cache</code> + <code>cacheLife</code> + <code>generateStaticParams</code> 可以实现完整的 ISR 功能。</p>
<h3 id="Q-可以混用旧-API-和新-API-吗？"><a href="#Q-可以混用旧-API-和新-API-吗？" class="headerlink" title="Q: 可以混用旧 API 和新 API 吗？"></a>Q: 可以混用旧 API 和新 API 吗？</h3><p><strong>A</strong>: 不可以。启用 <code>cacheComponents: true</code> 后：</p>
<ul>
<li>❌ 不能使用 <code>export const revalidate</code></li>
<li>❌ 不能使用 <code>export const dynamic</code></li>
<li>❌ 不能使用 <code>export const fetchCache</code></li>
<li>✅ 必须使用 <code>use cache</code> + <code>cacheLife</code></li>
</ul>
<h3 id="Q-Edge-Runtime-支持吗？"><a href="#Q-Edge-Runtime-支持吗？" class="headerlink" title="Q: Edge Runtime 支持吗？"></a>Q: Edge Runtime 支持吗？</h3><p><strong>A</strong>: 不支持。Cache Components 需要 Node.js 运行时。</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/getting-started/cache-components">Cache Components</a> - Cache Components 完整指南</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/directives/use-cache">use cache Directive</a> - use cache API 参考</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/cacheLife">cacheLife Function</a> - 缓存生命周期配置</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/cacheTag">cacheTag Function</a> - 缓存标签</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/updateTag">updateTag Function</a> - 立即更新缓存</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/functions/revalidateTag">revalidateTag Function</a> - 后台重新验证</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/blog/next-16">Next.js 16 Release</a> - Next.js 16 发布公告</li>
<li><a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/guides/upgrading/version-16">Upgrading to Next.js 16</a> - 升级指南</li>
</ul>
<h3 id="关键-API-速查"><a href="#关键-API-速查" class="headerlink" title="关键 API 速查"></a>关键 API 速查</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存指令</span></span><br><span class="line"><span class="string">&quot;use cache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存配置</span></span><br><span class="line"><span class="keyword">import</span> &#123; cacheLife, cacheTag &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"><span class="title function_">cacheLife</span>(<span class="string">&quot;hours&quot;</span>);</span><br><span class="line"><span class="title function_">cacheLife</span>(&#123; <span class="attr">stale</span>: <span class="number">60</span>, <span class="attr">revalidate</span>: <span class="number">300</span>, <span class="attr">expire</span>: <span class="number">3600</span> &#125;);</span><br><span class="line"><span class="title function_">cacheTag</span>(<span class="string">&quot;tag1&quot;</span>, <span class="string">&quot;tag2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存失效</span></span><br><span class="line"><span class="keyword">import</span> &#123; updateTag, revalidateTag &#125; <span class="keyword">from</span> <span class="string">&quot;next/cache&quot;</span>;</span><br><span class="line"><span class="title function_">updateTag</span>(<span class="string">&quot;tag&quot;</span>); <span class="comment">// 立即失效（Server Actions）</span></span><br><span class="line"><span class="title function_">revalidateTag</span>(<span class="string">&quot;tag&quot;</span>, <span class="string">&quot;max&quot;</span>); <span class="comment">// 后台重新验证（Server Actions + Route Handlers）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行时 API</span></span><br><span class="line"><span class="keyword">import</span> &#123; cookies, headers &#125; <span class="keyword">from</span> <span class="string">&quot;next/headers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connection &#125; <span class="keyword">from</span> <span class="string">&quot;next/server&quot;</span>;</span><br><span class="line"><span class="keyword">await</span> <span class="title function_">cookies</span>();</span><br><span class="line"><span class="keyword">await</span> <span class="title function_">headers</span>();</span><br><span class="line"><span class="keyword">await</span> <span class="title function_">connection</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Suspense</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Loading</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">DynamicComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="视频资源"><a href="#视频资源" class="headerlink" title="视频资源"></a>视频资源</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=MTcPrTIBkpA">Why PPR and how it works (YouTube, 10 分钟)</a></li>
</ul>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>Cache Components 的核心理念</strong>：</p>
<ol>
<li><p><strong>Cache Components &#x3D; PPR + use cache</strong></p>
<ul>
<li>PPR 是基础（静态外壳 + 流式传输）</li>
<li>use cache 是增强（显式缓存控制）</li>
</ul>
</li>
<li><p><strong>默认动态，选择性缓存</strong></p>
<ul>
<li>与旧版本相反，现在默认都是动态的</li>
<li>你决定什么需要缓存</li>
</ul>
</li>
<li><p><strong>三个关键工具</strong></p>
<ul>
<li>Suspense for runtime data（运行时数据）</li>
<li>Suspense for dynamic data（动态数据）</li>
<li>use cache for cached data（缓存数据）</li>
</ul>
</li>
<li><p><strong>从旧 API 迁移</strong></p>
<ul>
<li>移除所有 Route Segment Config</li>
<li>使用 <code>use cache</code> + <code>cacheLife</code> 替代</li>
<li>params&#x2F;searchParams 现在是 Promise(你从 Next.js 15 来的这点就问题不大)</li>
</ul>
</li>
<li><p><strong>最佳实践</strong></p>
<ul>
<li>根据数据特性选择策略</li>
<li>细粒度缓存优于粗粒度</li>
<li>合理使用 Suspense 嵌套</li>
<li>多级缓存标签便于失效管理</li>
</ul>
</li>
</ol>
<p>Cache Components 让缓存行为更清晰、更可控，是构建高性能 Next.js 应用的强大工具。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bingowith.me/2025/11/01/nextjs-16-cache-components-complete-guide/" data-id="cmhg21571002dwwva1dua8z4q" data-title="Next.js 16 Cache Components 完全指南" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cache-Components/" rel="tag">Cache Components</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Next-js/" rel="tag">Next.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Next-js-16/" rel="tag">Next.js 16</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web-Development/" rel="tag">Web Development</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2025/09/29/mysql-docker-mysqldump-backup-script/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">在容器中运行的mysql数据库定时备份脚本</div>
    </a>
  
</nav>

  
</article>


</section>
        
      </div>
      <footer id="footer">
  
    <aside id="sidebar" class="outer">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASP-NET/" rel="tag">ASP.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDN/" rel="tag">CDN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSR/" rel="tag">CSR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache-Components/" rel="tag">Cache Components</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPT/" rel="tag">GPT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPU/" rel="tag">GPU</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/H2/" rel="tag">H2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JOOQ/" rel="tag">JOOQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Next-js/" rel="tag">Next.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Next-js-16/" rel="tag">Next.js 16</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OS/" rel="tag">OS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RSC/" rel="tag">RSC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPA/" rel="tag">SPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSE/" rel="tag">SSE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web-Development/" rel="tag">Web Development</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/auth-js/" rel="tag">auth.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aws/" rel="tag">aws</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/azure/" rel="tag">azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blazor/" rel="tag">blazor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/claude/" rel="tag">claude</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cloudflare/" rel="tag">cloudflare</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/" rel="tag">docker compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/drizzle/" rel="tag">drizzle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/expo-router/" rel="tag">expo router</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/filerobot-image-editor/" rel="tag">filerobot-image-editor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/llm/" rel="tag">llm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maui/" rel="tag">maui</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/" rel="tag">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysqldump/" rel="tag">mysqldump</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nextjs/" rel="tag">nextjs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openai/" rel="tag">openai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/playwright/" rel="tag">playwright</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-native/" rel="tag">react native</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/remix/" rel="tag">remix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/route53/" rel="tag">route53</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rust/" rel="tag">rust</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shopify/" rel="tag">shopify</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shopify-CLI/" rel="tag">shopify CLI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-boot/" rel="tag">spring boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/timestamp/" rel="tag">timestamp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/timezone/" rel="tag">timezone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/troubleshooting/" rel="tag">troubleshooting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BF%BB%E8%AF%91/" rel="tag">翻译</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/ASP-NET/" style="font-size: 10px;">ASP.NET</a> <a href="/tags/C/" style="font-size: 10px;">C#</a> <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/CSR/" style="font-size: 10px;">CSR</a> <a href="/tags/Cache-Components/" style="font-size: 10px;">Cache Components</a> <a href="/tags/GPT/" style="font-size: 10px;">GPT</a> <a href="/tags/GPU/" style="font-size: 10px;">GPU</a> <a href="/tags/H2/" style="font-size: 10px;">H2</a> <a href="/tags/JOOQ/" style="font-size: 10px;">JOOQ</a> <a href="/tags/MySQL/" style="font-size: 14px;">MySQL</a> <a href="/tags/Next-js/" style="font-size: 10px;">Next.js</a> <a href="/tags/Next-js-16/" style="font-size: 10px;">Next.js 16</a> <a href="/tags/OS/" style="font-size: 10px;">OS</a> <a href="/tags/RSC/" style="font-size: 10px;">RSC</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/SPA/" style="font-size: 10px;">SPA</a> <a href="/tags/SSE/" style="font-size: 10px;">SSE</a> <a href="/tags/Web-Development/" style="font-size: 10px;">Web Development</a> <a href="/tags/auth-js/" style="font-size: 10px;">auth.js</a> <a href="/tags/aws/" style="font-size: 12px;">aws</a> <a href="/tags/azure/" style="font-size: 12px;">azure</a> <a href="/tags/blazor/" style="font-size: 10px;">blazor</a> <a href="/tags/claude/" style="font-size: 10px;">claude</a> <a href="/tags/cloudflare/" style="font-size: 10px;">cloudflare</a> <a href="/tags/docker/" style="font-size: 14px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker compose</a> <a href="/tags/dotnet/" style="font-size: 10px;">dotnet</a> <a href="/tags/drizzle/" style="font-size: 12px;">drizzle</a> <a href="/tags/expo-router/" style="font-size: 10px;">expo router</a> <a href="/tags/filerobot-image-editor/" style="font-size: 10px;">filerobot-image-editor</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/javascript/" style="font-size: 12px;">javascript</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/life/" style="font-size: 12px;">life</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/llm/" style="font-size: 10px;">llm</a> <a href="/tags/maui/" style="font-size: 10px;">maui</a> <a href="/tags/mybatis/" style="font-size: 10px;">mybatis</a> <a href="/tags/mysql/" style="font-size: 14px;">mysql</a> <a href="/tags/mysqldump/" style="font-size: 10px;">mysqldump</a> <a href="/tags/nextjs/" style="font-size: 16px;">nextjs</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/nodejs/" style="font-size: 12px;">nodejs</a> <a href="/tags/openai/" style="font-size: 12px;">openai</a> <a href="/tags/playwright/" style="font-size: 10px;">playwright</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/react/" style="font-size: 10px;">react</a> <a href="/tags/react-native/" style="font-size: 10px;">react native</a> <a href="/tags/remix/" style="font-size: 10px;">remix</a> <a href="/tags/route53/" style="font-size: 10px;">route53</a> <a href="/tags/rust/" style="font-size: 18px;">rust</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/shopify/" style="font-size: 14px;">shopify</a> <a href="/tags/shopify-CLI/" style="font-size: 10px;">shopify CLI</a> <a href="/tags/spring-boot/" style="font-size: 12px;">spring boot</a> <a href="/tags/timestamp/" style="font-size: 10px;">timestamp</a> <a href="/tags/timezone/" style="font-size: 10px;">timezone</a> <a href="/tags/troubleshooting/" style="font-size: 10px;">troubleshooting</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 16px;">翻译</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/11/">十一月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">九月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">八月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">七月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">六月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">五月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">三月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">一月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">十二月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">六月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/11/01/nextjs-16-cache-components-complete-guide/">Next.js 16 Cache Components 完全指南</a>
          </li>
        
          <li>
            <a href="/2025/09/29/mysql-docker-mysqldump-backup-script/">在容器中运行的mysql数据库定时备份脚本</a>
          </li>
        
          <li>
            <a href="/2025/08/14/nodejs-mysql-timezone-problem/">timestamp存取差几小时? mysql timestamp的timezone问题以及如何在mysql2设置</a>
          </li>
        
          <li>
            <a href="/2025/08/02/drizzle-mysql-bit-type/">drizzle如何处理mysql的bit类型</a>
          </li>
        
          <li>
            <a href="/2025/07/17/nextjs-client-navigation-get-previous-page/">Next.js 如何在客户端导航时获取上一页(referer)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 abaabaqua<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>





<script src="/js/script.js"></script>





  </div>
<!-- hexo injector body_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.30.0/tocbot.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.30.0/tocbot.min.js"></script>
  
    <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.location.pathname === '/') {
        return;
      }
      // 检查是否存在 .article-entry 元素
      const articleEntry = document.querySelector('.article-entry');
      if (!articleEntry) return; // 如果不存在，直接退出

      // 在 .article-title 后面插入一个 div，class 为 toc
      const articleTitle = document.querySelector('header.article-header');
      if (!articleTitle) {
        return;
      }

      const tocDiv = document.createElement('div');
      tocDiv.className = 'toc';
      articleTitle.insertAdjacentElement('afterend', tocDiv);
      // 初始化 tocbot
      tocbot.init({
        tocSelector: '.toc', // 将目录插入到刚刚创建的 .toc 中
        contentSelector: '.article-entry',
        headingSelector: 'h2, h3, h4',
        collapseDepth: 3,
        scrollSmooth: true,
        scrollSmoothDuration: 420,
      });
    });
    </script>
  
    <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 创建回到顶部按钮
      const backToTopButton = document.createElement('div');
      backToTopButton.id = 'back-to-top';
      backToTopButton.innerHTML = '↑ TOP';
      document.body.appendChild(backToTopButton);

      // 监听滚动事件
      window.addEventListener('scroll', function () {
        if (window.scrollY > 300) { // 当滚动超过300px时显示按钮
          backToTopButton.classList.add('show');
        } else {
          backToTopButton.classList.remove('show');
        }
      });

      // 点击按钮回到顶部
      backToTopButton.addEventListener('click', function () {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    });
    </script>
  <!-- hexo injector body_end end --></body>
</html>